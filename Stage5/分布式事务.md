# 分布式事务

## 搭建业务案例

**数据库初始化工具**  
执行多次测试后，库存和账户金额都会减少，可以执行初始化工具，把数据重置到初始状态，再重新测试

1. 新建空工程： seata-at
2. 新建spring模块： db-init
3. 添加依赖： spring jdbc，mysql driver
4. yml 配置数据库连接
5. 在 resources 目录创建四个 sql 脚本文件
    - 新建sql子目录，在sql 目录下创建文件
6. 启动类中添加代码，执行这四个 sql 脚本

**mysql 旧版本，需要调整sql脚本**

1. 四个文件中的 `DATETIME(6)`，把小括号6去掉，改成`DATETIME`
2. order.sql 最后一行，两个 NOW() 改成 0

**三个业务模块**

1. 新建 spring 模块
2. 调整 pom.xml，从 order-parent 继承
3. yml配置
    - app.name
    - port
    - 注册中心
    - jdbc连接信息
    - mybatis-plus
    - 显示 mapper 执行的sql语句日志
    - bootstrap.yml 选择网卡
4. 实体类
5. Mapper
6. 启动类添加注解：`@MapperScan`
7. Service
8. Controller

### 全局唯一id发号器

分布式系统中，多个模块可以从发号器获得不重复的id

https://github.com/lookingatstarts/easyIdGenerator

这个开源项目支持两种产生id的算法：

- 雪花算法
- 使用数据库产生不重复id

### 订单远程调用 storage, account, easy-id

1. 父项目中已经添加 feign 依赖
2. 启动类添加注解：`@EnableFeignClients`
3. 添加三个远程调用接口
    - EasyIdClient
    - StorageClient
    - AccountClient
4. OrderServiceImpl 完成远程调用
5. 禁用 Ribbon 重试，避免干扰观察分布式事务执行效果

### Seata AT 事务

**部署 seata server (TC 事务协调器)**

1. 课前资料\分布式事务\seata-server-1.3.zip 解压缩
2. 修改三个配置文件
    - registry.conf -- 向注册中心注册
    - file.conf -- 协调器运行过程中记录的日志数据，要存到数据库
    - seata-server.bat -- 使用的内存默认 2G，测试环境把内存改小：256m
3. 执行 seata-server.bat 启动协调器

- 必须使用JDK1.8
- 不能关闭命令窗口
- 窗口中的内容不能选中，如果选中，窗口中的应用会挂起（暂停）

**订单模块添加 Seata AT 事务**

1. 父项目中添加 seata 依赖
2. order中配置三个配置文件
    - application.yml -- 事务组的组名
    - registry.conf -- 注册中心的地址
    - file.conf -- 上面的事务组，使用哪个协调器
3. 新建自动配置类，创建 DatasourceProxy 数据源代理对象
    - AT事务的自动事务处理代码，都是有数据源代理提供的
4. 禁用spring默认的数据源配置
5. 在业务方法上添加事务注解
    - spring 本地事务 `@Transactional`
    - seata 启动全局事务 `@GlobalTransactional` （只在第一个模块上添加）

### TCC事务

有侵入的事务方案

- 事务控制代码需要自己编写
- 业务代码也需要修改
- 底层数据库表结构也需要修改

AT事务适用于80%的业务场景,在一些复杂情况下,自动事务无法自动处理,就需要手动处理事务

**TCC - 两个阶段的三个操作**

- 第一阶段
    - Try-预留资源/冻结数据
- 第二阶段
    - Confirm-确认资源,使用冻结数据完成业务处理
    - Cancel-取消预留资源,把之前冻结的数据回滚(解冻,恢复)

**新建工程,导入无事务版本**

1. 新建工程: seata-tcc
2. 解压缩无事务版本4个文件夹到工程目录
3. 导入
    - project structure添加module
    - double shift搜索add maven project
    - 拖拽pom.xml,右键导入maven project

**添加TCC事务**

1. 添加seata依赖
2. 三个配置文件
    - application.yml -- 事务组的组名
    - registry.conf -- 注册中心的地址
    - file.conf -- 事务组对应协调器
3. 修改Mapper,添加TCC数据库操作
4. 按照seata tcc的实现规则,定义TccAction接口和实现
    - 添加三个方法,实现TCC三个操作
    - 三个方法都添加`@Transactional`注解,控制本地事务
5. 修改业务方法,调用TccAction的第一阶段方法
6. 第二阶段的方法,由seata的RM组件自动调用
7. 在第一个模块,添加`@GlobalTransactional`启动全局事务